<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>DataBase Manage</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <link rel="stylesheet" href="../static/css/font-awesome.min.css">
    <link rel="stylesheet" href="../static/css/bwdb.css">
    <link rel="stylesheet" href="static/css/manage.css">
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <script>window.$ = window.jQuery = require('jquery');</script>
    <script src="../static/js/bootstrap.min.js"></script>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
    <script>
        var slideflag = 0;
        var textflag = 0;
        var picflag = 0;
        var firstid = 0;
        var now_proid = -1;
        var now_buildid = -1;
        var zipflag = 0;
        var verflag = 0;
        const ipcRenderer = require('electron').ipcRenderer;
        const remote = require('electron').remote;
        const { Menu, MenuItem } = remote;

        function getpar_height(sel) {
            var w = 0;
            $(sel).each(function () {
                w = w + parseInt($(this).height());//获取宽度。并累加
            });
            return w;
        }
        $(window).ready(function () {
            now_height = document.documentElement.clientHeight - 55;
            now_width = document.documentElement.clientWidth - 355;
            $('.bwdb_sidebar').css('max-height', now_height);
            $('.bwdb_sidebar').css('height', now_height);
            if ($('.bw_sidebar_info_box').css('display') == 'none') {
                $('.bwdb_sidebarA').css('max-height', now_height);
                $('.bwdb_sidebarA').css('height', now_height);
            } else {
                $('.bwdb_sidebarA').css('max-height', now_height - $('.bw_sidebar_info_box').height);
                $('.bwdb_sidebarA').css('height', now_height - $('.bw_sidebar_info_box').height);
            }
            if (getpar_height('.bwdb_sidebarA') > $('.bwdb_sidebarA').css('max-height')) {
                $('.bwdb_sidebarA').css('overflow-y', 'scroll');
            } else {
                $('.bwdb_sidebarA').css('overflow-y', 'auto');
            }
            console.log(document.documentElement.clientWidth);
            ipcRenderer.send('getsyslist', 'ping');
        });
        $(window).resize(function () {
            now_height = document.documentElement.clientHeight - 55;
            now_width = document.documentElement.clientWidth - 355;
            $('.bwdb_sidebar').css('max-height', now_height);
            $('.bwdb_sidebar').css('height', now_height);
            if ($('.bw_sidebar_info_box').css('display') == 'none') {
                $('.bwdb_sidebarA').css('max-height', now_height);
                $('.bwdb_sidebarA').css('height', now_height);
            } else {
                $('.bwdb_sidebarA').css('max-height', now_height - $('.bw_sidebar_info_box').height);
                $('.bwdb_sidebarA').css('height', now_height - $('.bw_sidebar_info_box').height);
            }
            if (getpar_height('.bwdb_sidebarA') > $('.bwdb_sidebarA').css('max-height')) {
                $('.bwdb_sidebarA').css('overflow-y', 'scroll');
            } else {
                $('.bwdb_sidebarA').css('overflow-y', 'auto');
            }
            console.log(document.documentElement.clientWidth);
        });
        $(document).on('click', '.bwdb_select_item', function() {
                console.log($(this).html());
                $(".search_box_title").html($(this).html());
                $(".search_box_title").attr('data-id',$(this).attr('data-id'));
                $(".search_box_title").attr('data-id-codename',$(this).attr('data-id-codename'));
                console.log($(this).attr('data-id'));
                now_buildid=-1;
                now_proid=-1;
                ipcRenderer.send('getbuildstage', $(this).attr('data-id'));
                if(slideflag==1){
                    $("#bwdb_nav_select_bar").hide();
                    slideflag=0; 
                }
                if($("#homeinfobox").css('display')!='none'){
                    $("#verinfobox").show();
                    $("#homeinfobox").hide();
                }
                $('.bwdb_sidebarA').scrollTop(0-$('.bwdb_sidebarA').scrollTop);
            });
            $(".bwdb_content").click(function(){
                if(slideflag==1){
                    $("#bwdb_nav_select_bar").slideUp('100ms');
                    slideflag=0; 
                }
            });
            $(document).on('mouseenter', '.big_stage_item', function() {
                $(this).children('.big_stage_text').css('background-color','#d4e2ee');
            });
            //$(".big_stage_item").mouseleave(function(){
            $(document).on('mouseleave', '.big_stage_item', function() {
                $(this).children('.big_stage_text').css('background-color','#ececec');
            });
            
            //$(".bwdb_sidebar_item").click(function(){
            $(document).on('click', '.bwdb_sidebar_item', function() {   
                verflag=1; 
                $('.bwdb_sidebar_item').css('background-color','unset');
                $('.bwdb_sidebar_item').css('color','unset');
                $(this).css('background-color','#19478a');
                $(this).css('color','#fff');
                $('.bwdb_infobox_textarea').hide();
                $('.info_box_items_btn_text').attr('class','info_box_items_btn_text');
                console.log($(this).attr('data-id'));
                if($('.bw_sidebar_info_box').css('display')=='none'){
                    get_build_info($('.search_box_title').attr('data-id'),$(this).attr('data-id'));
                }else{
                    console.log($(this).attr('data-id-proid'));
                    get_build_info($(this).attr('data-id-proid'),$(this).attr('data-id'));
                }
                if($("#homeinfobox").css('display')!='none'){
                    $("#verinfobox").show();
                    $("#homeinfobox").hide();
                }
                
            });
            $('.bwdb_nav_search_text').keypress(function (e){
 　　           if(e.keyCode == 13){
                   console.log($(this).val());
                   ipcRenderer.send('searchbuildlist',$(this).val());
　　　          }
            });  
            function slide_select(){
            if(slideflag==0){
                $("#bwdb_nav_select_bar").slideDown('100ms');
                slideflag=1;
            }else{
                $("#bwdb_nav_select_bar").slideUp('100ms');
                slideflag=0;
            }
        }
        function show_search_textbox(){
            if(slideflag==1){
                    $("#bwdb_nav_select_bar").slideUp('100ms');
                    slideflag=0; 
            }
            if(textflag==0){
                $('.search_btn').css('border','#fff 2px solid');
                $('.bwdb_nav_search_text').val('');
                $(".bwdb_nav_search").show();
                $(".bw_sidebar_info_box").html('按回车键开始搜索<br>单击放大镜按钮以关闭搜索工具。')
                $(".bw_sidebar_info_box").show();
                $(".bwdb_sidebarA").hide();
                verflag=1;
                textflag=1;
            }else{
                $('.search_btn').css('border','unset');
                $(".bwdb_nav_search").hide();
                $(".bw_sidebar_info_box").hide();
                $(".bwdb_sidebarA").show();
                if($(".bw_sidebar_info_box").html().indexOf('按回车键开始搜索') == -1){
                $(".search_box_title").html($(".bwdb_select_item[data-id='"+now_proid+"']").html());
                $(".search_box_title").attr('data-id',$(".bwdb_select_item[data-id='"+now_proid+"']").attr('data-id'));
                $(".search_box_title").attr('data-id-codename',$(".bwdb_select_item[data-id='"+now_proid+"']").attr('data-id-codename'));
                verflag=0;
                ipcRenderer.send('getbuildstage', now_proid);
                }
                textflag=0;
            }
        }
        ipcRenderer.on('syslist', function(event, arg) {
            console.log(arg);
            var s=JSON.parse(arg);
            $('#bwdb_nav_select_bar').html('');
            for(var i = 0; i < s.length; i++) {
                console.log(s[i]);
                var s1=s[i][1];
                s1=s1.replace('\"','&quot');
                $("#bwdb_nav_select_bar").append('<div class="bwdb_select_item"'+ 'data-id="'+s[i][0]+'" data-id-codename="'+s[i][2]+'">'+s1+'</div>');
            };
            //默认配置
            $('.search_box_title').attr('data-id-codename',$(".bwdb_select_item[data-id='1']").attr('data-id-codename'));
            $('.search_box_title').attr('data-id','1');
            $('.search_box_title').html(s[0][1]);
            ipcRenderer.send('getbuildstage', 1);
            get_build_info(1,1);
            
        });
        ipcRenderer.on('stagelist', function(event, arg) {
            console.log(arg);
            console.log($('.search_box_title').attr('data-id'));
            var s=JSON.parse(arg[1]);
            $('.bwdb_sidebarA').html('');
            for(var i = 0; i < s.length; i++) {
                console.log(s[i]);
                if(s[i].length>30){
                    var s1=s[i].substring(0,30)+'...'
                }else{
                    var s1=s[i]
                }
                $(".bwdb_sidebarA").append('<div class="big_stage_divider"><div class="big_stage_item"><span class="big_stage_text" title="'+s[i]+'">'+s1+'</span></div></div><div class="build_list" data-id="'+s[i]+'" data-type="build_stage" >');
                ipcRenderer.send('getbuildlist', [arg[0],s[i]]);
            };
            ipcRenderer.send('show-win', 'win');
            //添加相关的代码
        });
        ipcRenderer.on('buildlist', function(event, arg) {
            console.log(arg);
            console.log($('.search_box_title').attr('data-id'));
            var s=JSON.parse(arg[2]);
            $("[data-type='build_stage'][data-id='"+arg[1]+"']").html('');
            for(var i = 0; i < s.length; i++) {
                console.log(s[i]);
                $("[data-type='build_stage'][data-id='"+arg[1]+"']").append('<div class="sidebar_ver bwdb_sidebar_item" data-id="'+s[i][0]+'" data-type="build_item">'+s[i][1]+'</div>');
            };
            //添加相关的代码
            //alert(s[s.length-1][0]);
            if(firstid!=$(".bwdb_sidebarA").children(".build_list:first").children(".bwdb_sidebar_item:first").attr('data-id')  && now_proid==-1){
                get_build_info(arg[0],$(".bwdb_sidebarA").children(".build_list:first").children(".bwdb_sidebar_item:first").attr('data-id'));
            } 
            if(now_buildid>0 && $('.bwdb_sidebar_item[data-id="'+now_buildid+'"]').length>0){
                if($("#homeinfobox").css('display')=='none'){
                $('.bwdb_sidebar_item[data-id="'+now_buildid+'"]').css('background-color','#19478a');
                $('.bwdb_sidebar_item[data-id="'+now_buildid+'"]').css('color','#fff');
                }
                get_build_info(now_proid,now_buildid);
                //$('.bwdb_sidebar').scrollTop(0);
            }
            if(getpar_height('.bwdb_sidebarA')>$('.bwdb_sidebarA').css('max-height')){
                $('.bwdb_sidebarA').css('overflow-y','scroll');
            }else{
                $('.bwdb_sidebarA').css('overflow-y','auto');
            }
        });
    </script>
</head>

<body style="margin: 0;overflow: hidden;">
    <nav class="navbar navbar-expand-lg navbar-light bwdb_toolbar">
        <div class="nav_search_1">
            <div class="nav_search" onclick="slide_select();">
                <div class="search_box">
                    <div class="search_box_title">Windows 1.0</div>
                </div>
                <div class="search_box_down"><i class="fa fa-angle-down" aria-hidden="true"></i></div>

            </div>
            <div class="search_btn" onclick="show_search_textbox();"><i class="fa fa-search" aria-hidden="true"></i>
            </div>
            <div class="title_bar">DataBase Manage</div>
        </div>
        <div class="nav_right_btn">
            <div class="nav_btn" onclick="switch_home();"><i class="fa fa-plus" aria-hidden="true"></i></div>
            <div class="nav_btn" onclick="switch_home();"><i class="fa fa-trash-o" aria-hidden="true"></i></div>
            <div class="nav_btn" onclick="setting_btn_do();"><i class="fa fa-pencil" aria-hidden="true"></i></div>
            <div class="nav_btn" onclick="setting_btn_do();"><i class="fa fa-refresh" aria-hidden="true"></i></div>
            <div class="nav_btn" onclick="setting_btn_do();"><i class="fa fa-cog" aria-hidden="true"></i></div>
            <div class="nav_btn" onclick="setting_btn_do();"><i class="fa fa-info-circle" aria-hidden="true"></i></div>
        </div>
    </nav>
    </div>
    <div class="bwdb_content">
        <div class="bwdb_sidebar">
            <div class="bw_sidebar_info_box">
                按回车键开始搜索<br>单击放大镜按钮以关闭搜索工具。
            </div>
            <div class="bwdb_sidebarA">

            </div>
        </div>
        <div class="bwdb_infobox" id="homeinfobox">
            <div class="home_title">
                <div>
                    <h5>点击侧边栏的Build开始编辑，点击右上方的 <i class="fa fa-plus" aria-hidden="true"></i> 添加产品/Build。</h5>
                </div>
                <div class="version_info" id="basedb_version">基础数据库版本：V16.66，更新于2020/01/01日</div>
                <div class="version_info" id="gallerypak_version">图片数据库版本：V16.66，更新于2020/01/01日</div>
            </div>
        </div>
    </div>
    <div class="bwdb_nav_select" id='bwdb_nav_select_bar'>

    </div>
    <div class="bwdb_nav_search">
        <input type="text" id="email" placeholder="在这里搜索" class="bwdb_nav_search_text">
    </div>
</body>

</html>